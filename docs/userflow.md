# MaFia Reservation – 기능 단위 유저플로우 최종본

본 문서는 로그인/회원가입 및 결제 기능을 제외한, 비회원 콘서트 예약 흐름의 기능 단위 유저플로우를 정리한다. 각 유저플로우는 입력/처리/출력으로 구성되며, 엣지케이스와 예외 상황을 포함한다. 구체적인 문구는 포함하지 않는다.

---

## 유저플로우 1: 메인(홈) – 콘서트 목록 탐색 및 상세 진입

- 입력
  - 페이지 진입
  - 정렬 변경(예: 일자, 인기 등)
  - 필터 선택/해제(예: 장소, 날짜 범위)
  - 페이지네이션/무한 스크롤 추가 로드
  - 콘서트 카드 클릭
  - 새로고침/뒤로가기
- 처리
  - 초기 목록 조회: 정렬/필터/페이지 파라미터 반영, 요청 중 스켈레톤 표시
  - 신청인원/수용인원 계산: 서버 제공 값 사용 또는 등급별 좌석 합산 검증
  - 요청 중복 제어: 빠른 연속 입력 시 이전 요청 취소, 마지막 조건만 반영
  - 캐싱/프리패치: 기존 목록 캐시, 카드 포커스/호버 시 상세 데이터 사전 로드
  - 빈 결과 처리: 조건 유지 + 빈 상태 플래그 세팅
  - 오류 처리: 네트워크/서버 오류 시 재시도 가능 상태 전환, 캐시가 있으면 표시
  - 상태 보존: 정렬/필터/스크롤 위치 유지(뒤로가기·새로고침 대비)
  - 시간/타임존 정규화, 데이터 정합성 보정(누락 필드 기본값, 중복 제거, 페이지 범위 보정)
- 출력
  - 카드 그리드: 공연 제목, 일자, 장소, 신청인원/수용인원 표시
  - 로딩 스켈레톤/플레이스홀더
  - 빈 결과/오류 상태 UI 및 재시도 인터랙션
  - 추가 로드 인터랙션(무한 스크롤/더보기)
  - 카드 클릭 시 상세 페이지 이동(상태/스크롤 복원 가능)

---

## 유저플로우 2: 콘서트 상세 보기 및 좌석 현황 확인

- 입력
  - 페이지 진입(목록에서 클릭, 직접 링크, 새로고침)
  - 스크롤/섹션 확장·축소(좌석 등급 안내)
  - CTA 클릭(좌석 선택 이동)
  - 뒤로가기/앞으로가기
  - 네트워크 상태 변화
- 처리
  - 식별자 검증 및 상세 데이터 조회(제목/일자/장소)
  - 시간대 정규화/포맷팅
  - 좌석 등급 데이터 조회(Special/Premium/Advanced/Regular)
    - 등급 존재성/순서 보정, 누락 기본값 보완
    - 등급별 남은좌석 계산(전체 − 예약완료), 비정상 값 보정/로깅
  - 판매 상태 판단(매진/종료/취소 등) 및 CTA 활성 조건 계산
  - 데이터 정합성 확인(총좌석 합계, 수용인원 연동값 검증)
  - 오류/오프라인/타임아웃 처리(재시도 정책, 캐시 우선)
  - 좌석선택 페이지 프리패치, 리소스 로드 실패 시 대체 리소스 적용
  - 접근성 메타데이터 구성, 관측 이벤트 로깅(식별정보 제외)
- 출력
  - 상세 정보(제목/일자/장소) 및 등급별 가격·남은좌석/전체좌석 표시
  - 상태별 UI: 로딩/오류/비정상 데이터/매진·종료·취소
  - CTA 상태(활성/비활성) 및 전환(좌석 선택 이동)
  - 오프라인 시 캐시 데이터 표시 및 상호작용 제한
  - 좌석 수 변동 알림/자동 갱신(필요 시)

---

## 유저플로우 3: 좌석 선택

- 입력
  - 페이지 진입(상세에서 이동, 직접 링크, 새로고침)
  - 등급 필터/정렬 선택·변경
  - 좌석 지도에서 좌석 선택/해제(멀티 선택)
  - 선택 좌석 전체 해제
  - 확대/축소/스크롤(ABCD 구역 탐색)
  - 다음 단계 진행(예약하기) 클릭
  - 장시간 미입력/비활동
  - 네트워크 상태 변화
- 처리
  - 좌석/등급/가격 데이터 조회 및 캐싱
  - 좌석 상태 계산: 예약완료/홀드중/선택가능/제한석 등 상태 반영
  - 선택 규칙 검증
    - 서버 상태와 동기화, 동시성 제어: 선택 시 서버 홀드 생성, TTL 관리/주기 갱신
    - 최대 선택 좌석 수 제한, 등급 혼합 규칙 적용(공연 설정 기반)
    - 연속석 제약이 있을 경우 인접성 검사 및 보정 제안
  - 합계 계산: 등급별/총 금액 및 수량 산출(정책 없으면 스킵)
  - 실패/경합 처리
    - 선택 직후 경합 시 재검증 → 충돌 좌석만 해제, 최신 상태 반영
    - 홀드 만료 시 선택 좌석 자동 해제 및 재계산
    - 네트워크 오류 시 낙관적 선택 롤백 및 재시도 큐 관리
  - 접근성/성능: 키보드 내비게이션, 가상 스크롤/타일링
  - 다음 단계 이동 전 최종 검증: 선택 좌석 존재/유효성 재검증, 홀드 토큰 준비
- 출력
  - 좌석 지도(ABCD 구역, 상태별 시각 구분) 및 선택 요약(등급별 수량/금액, 총합)
  - 로딩/오류/빈 상태 UI
  - 규칙 위반/경합/만료 피드백 및 수정 안내
  - 홀드 남은 시간/자동 갱신 표시(가능 시)
  - 다음 단계 CTA 활성/비활성 및 진행 시 체크아웃 전환

---

## 유저플로우 4: 예약 정보 입력

- 입력
  - 페이지 진입(좌석 선택에서 이동, 직접 링크, 새로고침)
  - 예약자 명 입력/수정/삭제
  - 휴대폰 번호(숫자만) 입력/수정/삭제
  - 비밀번호 입력/수정/삭제
  - 이전 단계로 이동, 제출 클릭(중복 클릭 포함)
  - 네트워크 상태 변화
- 처리
  - 선택 좌석/홀드 토큰 유효성 재검증(TTL 확인, 만료 시 좌석 해제)
  - 클라이언트 검증: 공백 제거, 길이/형식 검증(이름, 전화번호 10~11, 비밀번호 최소 길이)
  - 포맷 정규화: 비숫자 제거, 트리밍
  - 제출 중복 방지: 버튼 비활성화, 진행 중 상태, 멱등 키 부여
  - 서버 사전 검증: 좌석 최신 상태 재조회, 경합 좌석 식별, 판매 가능 상태 확인
  - 트랜잭션 처리(원자성)
    - 홀드 유효성 최종 확인
    - 좌석 상태 전환(홀드 → 예약완료), 중복/경합 보정
    - 예약 레코드 생성(비밀번호 해시 저장, 민감정보 최소화)
    - 합계 금액 계산, 수량/금액 정합성 체크
  - 실패 처리: 입력 유효성 오류(필드 단위), 홀드 만료/경합(해당 좌석만 해제 후 최신 상태 동봉), 네트워크/서버 오류(재시도 가능)
  - 접근성/보안: 포커스 이동/ARIA 동기화, 민감정보 로깅 방지/전송 후 메모리 제거
- 출력
  - 필드별 유효/오류 상태, 전송 중 상태 및 중복 제출 차단
  - 선택 좌석/등급/수량/금액 요약 고정 노출
  - 성공 시 예약 식별자 기반 예약 완료로 전환
  - 실패 시 유형별 피드백 및 재시도/재선택 유도
  - 사이드이펙트: 좌석 재고 반영, 관측 이벤트 기록, 민감정보 비가시화

---

## 유저플로우 5: 예약 완료 확인

- 입력
  - 페이지 진입(체크아웃 완료 리다이렉트, 직접 링크, 새로고침)
  - 후행 행동 클릭(예약 조회 이동, 메인 이동, 공유/저장)
  - 뒤로가기/앞으로가기
  - 네트워크 상태 변화
- 처리
  - 식별자/토큰 검증: `reservationId` 및 접근 토큰 유효성 확인
  - 데이터 조회: 예약 상태, 공연 정보, 좌석 목록, 합계 금액
  - 일관성 보정: 비동기 단계 존재 시 폴링/SSE/SWR 동기화, 불일치 감지 시 재조회
  - 개인정보 최소화: 민감정보 마스킹, 비밀번호 미노출
  - 중복 제출/새로고침 보호: 멱등 키로 중복 생성 판별(표시는 단건 기준)
  - 오류/예외 처리: 식별자 오류/미존재/만료/권한 없음 → 접근 불가, 네트워크/서버 오류 → 재시도 가능
  - 접근성/성능: 핵심 정보 우선 렌더링, 예약 조회/메인 프리패치, 관측 로깅
- 출력
  - 예약 요약: 예약 번호, 공연 정보, 좌석 목록, 금액, 생성 시각
  - 상태 UI: 로딩/오류/접근 불가/완료
  - 후행 CTA: 예약 조회 이동, 메인 이동, 공유/저장
  - 사이드이펙트: 데이터 프리패치, 관측 이벤트 기록

---

## 유저플로우 6: 예약 조회

- 입력
  - 페이지 진입
  - 휴대폰 번호(숫자만) 입력/수정/삭제
  - 비밀번호 입력/수정/삭제
  - 제출 클릭(중복 클릭 포함)
  - 새로고침/뒤로가기
  - 오프라인/온라인 전환
- 처리
  - 입력 정규화: 공백/하이픈 제거, 숫자만 유지, 길이 검증(10~11)
  - 비밀번호 최소 길이 검증, 불필요 문자 제거
  - 제출 중복 방지: 진행 중 상태 토글, 최근 요청 취소
  - 인증 로직: 전화번호 + 비밀번호 해시 기반 조회(존재 여부 노출 방지)
  - 결과 조회: 예약 목록 페이징/정렬(최신순), 최소 필드 세트 반환
  - 보안/안티어뷰즈: 실패 누적 시 지연/쓰로틀, 임계치 초과 시 추가 검증 요구, 구체 사유 비노출
  - 장애/경합 처리: 서버/네트워크 오류 재시도(지수 백오프), 오프라인 시 입력 보존 + 복구 감지
  - 세션 최소화: 조회 성공 시 단기 조회 토큰 발급(TTL), 상세 진입 시 재검증, 민감정보 미저장
  - 데이터 정합성: 중복 예약 병합 규칙, 누락 필드 기본값 보완/비정상 상태 로깅
  - 프리패치: 가시 항목 예약 상세 사전 로드
- 출력
  - 폼 상태: 필드 유효/오류 표시, 제출 중 비활성화, 일반화된 오류 피드백
  - 결과 리스트(없음/일부/전체)와 페이징/더보기
  - 오프라인/오류 상태 UI 및 재시도 인터랙션
  - 사이드이펙트: 조회 토큰 저장(TTL), 상세 프리패치, 관측 이벤트 기록

---

## 유저플로우 7: 예약 상세 조회

- 입력
  - 페이지 진입(예약 목록에서 선택, 직접 URL, 새로고침)
  - 조회 토큰/세션 존재 또는 만료
  - 뒤로가기/앞으로가기
  - 후행 행동 클릭(목록 복귀, 메인 이동, 인쇄/저장)
  - 네트워크 상태 변화
- 처리
  - 식별자 검증: `reservationId` 형식/존재 확인
  - 권한 확인: 조회 토큰/세션 유효성 검사(TTL/서명/스코프), 불일치 시 재인증 흐름 분기
  - 데이터 조회: 예약 요약, 공연 정보, 좌석 목록, 금액, 생성 시각, 상태
  - 정합성 보정: 좌석 배정/상태 최신화, 공연 상태 변경 반영, 이상치 로깅
  - 개인정보 처리: 민감정보 마스킹, 비밀번호/원문 식별자 미노출
  - 예외/오류 대응: 미존재/만료/권한 없음/형식 오류 → 접근 불가, 서버/네트워크 오류 → 재시도 가능
  - 오프라인 대응: 캐시가 있으면 읽기 전용 표시, 행위 제한
  - 관측/로깅: 노출/이탈 이벤트 기록(식별정보 제외)
- 출력
  - 예약 상세: 예약 번호, 공연 정보, 좌석 목록, 금액, 생성 시각, 상태
  - 상태 UI: 로딩/완료/접근 불가/오류/오프라인
  - 후행 CTA: 목록 이동, 메인 이동, 인쇄/저장
  - 사이드이펙트: 목록/메인 프리패치, 관측 이벤트 기록

---

## 유저플로우 8: 공통 예외 및 오프라인 처리

- 입력
  - 네트워크 이벤트: 오프라인 전환, 온라인 복귀, 고지연, 타임아웃
  - 요청 실패: 4xx(권한/경합/검증/과도 요청 등), 5xx, CORS/파싱 오류
  - 사용자 행동: 중복 클릭, 빠른 조건 변경, 새로고침/뒤로가기, 다중 탭 동시 사용
  - 환경 변화: 백그라운드 전환, 스토리지 제한/비활성화, 서비스 워커 업데이트, 클럭 스큐
- 처리
  - 글로벌 인터셉터
    - 요청 중복 제거/취소 토큰, 멱등 키(변경 요청), 지수 백오프/재시도(읽기 전용)
    - 에러 분류 매핑: 네트워크/타임아웃/4xx/5xx/파싱 → 화면 상태 코드 통일
    - 경합 처리: 최신 상태 재조회 후 선택/홀드 무효화·부분 롤백
    - 검증 실패 처리: 필드 단위 매핑/재검증, 과도 요청은 지연/쓰로틀
  - 오프라인 모드
    - 읽기: 캐시 허용(SWR/ETag), 스테일 명시
    - 쓰기: 변경 요청은 큐잉 금지, 즉시 차단 및 온라인 전환 유도
  - 상태 동기화
    - ETag/버전스탬프 무결성 확인, 응답 순서 강제(레이스 무시)
    - 좌석 홀드 TTL 서버 기준, 타이머 보정/재검증
    - 온라인 복귀 시 전역 리밸리데이션, 낙관적 상태 원복/재적용
  - 동시성/다중 탭
    - 탭 간 뮤텍스(스토리지 락), 동일 좌석 홀드 단일화
    - 요청 단위 트랜잭션, 부분 실패 보상 로직
  - 보안/프라이버시/관측
    - 구체 사유 비노출, PII 로깅 금지
    - 에러 샘플링/분류 수집, 클라이언트 지표 전송(오프라인 시 보류)
- 출력
  - 글로벌 상태 표시: 오프라인 배너/아이콘, 로딩/오류/스테일 표시, 재시도 인터랙션
  - 상호작용 제어: 변경형 CTA 비활성화, 읽기 전용 안내, 중복 제출 방지
  - 데이터 피드백: 최신화/원복/부분 성공 반영, 충돌 좌석만 해제 후 목록 갱신
  - 사이드이펙트: 실패 텔레메트리 전송, 온라인 복귀 시 일괄 재검증

---

본 문서는 MaFia Reservation의 핵심 유저플로우를 최종 정리한 산출물이다. 추가 플로우가 필요한 경우 이어서 확장한다.


